<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="theme-color" content="#2ecc71">
<meta property="og:url" content="http://thecynicaldba.com/indexing-for-idiots" />
<title> Indexing for idiots | the_cynical_dba</title>
<meta property="og:title" content=" Indexing for idiots | the_cynical_dba"/>
<meta property="og:description" name="description" content="Indexing for idiots" />
<meta name="keywords" content="MSSQL Server">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://thecynicaldba.com/indexing-for-idiots">
<link rel="alternate" type="application/rss+xml" title="the_cynical_dba" href="http://thecynicaldba.com/feed.xml" />
<script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5961447a33add90011bd1e36&product=inline-share-buttons' async='async'></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-102162987-1', 'auto');
  ga('send', 'pageview');
</script>
<script>base_url = "";</script>
  </head>
  <body class="single">
    <main class="main-container">
        <header class="site-header">
  <div class="container txt-center">
    <a href="#" class="nav-toogle js-menu-trigger sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </a>
    <nav class="js-menu sliding-panel-content">
      <ul>
        <li><a href="/">home</a></li>
        <li><a href="/author">author</a></li>
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> feed</a></li>
      </ul>
    </nav>
    <div class="js-menu-screen sliding-panel-fade-screen"></div>
      <h1 class="page-title">Indexing for idiots</h1>
      <p class="post-meta">Aug 12, 2017</p>
  </div>
</header>
        <section class="main-content">
          <article class="post">
  <div class="post-content container">
    <p>There’s no such thing as a one size fits all solution when it comes to indexing.
Because of this, learning how to properly index can be a frustrating endeavor when much of the information out there appears to be highly subjective.
If the basics are not broken down into digestible chunks, odds are I will consider what I am reading a nice exercise on database design theory, instead of something I am ready to apply in a real-world scenario.</p>
<p>Please note the following facts before proceeding to the example:</p>
<ul>
  <li>A table is either clustered or a heap.</li>
  <li>Clustered tables contain data that is physically sorted by a single clustered index.</li>
  <li>A heap does not contain a clustered index and it’s essentially a pile of unsorted data.</li>
  <li>It’s possible to have one or more <strong>non</strong>-clustered indexes on a heap or a clustered table.</li>
</ul>
<hr />
<h2 id="indexing-example">Indexing Example</h2>
<p>Let’s start off with a heap populated by two rows:</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Books</span> <span class="p">(</span>
    <span class="n">Id</span>     <span class="nb">INT</span> <span class="k">IDENTITY</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">Title</span>  <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="n">Author</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NULL</span>
<span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Books</span> <span class="p">(</span><span class="n">Title</span><span class="p">,</span> <span class="n">Author</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;The Lord of the Rings&#39;</span><span class="p">,</span><span class="s1">&#39;J. R. R. Tolkien&#39;</span><span class="p">);</span>
<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Books</span> <span class="p">(</span><span class="n">Title</span><span class="p">,</span> <span class="n">Author</span><span class="p">)</span> 
    <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;Le Morte d&#39;&#39;Arthur&#39;</span><span class="p">,</span><span class="s1">&#39;Thomas Malory&#39;</span><span class="p">);</span></code></pre></div>
<p>Select the values <font size="3">([Title] based upon [Author])</font> and view the execution plan by enabling the SSMS option “Include Actual Execution Plan” (Ctrl-M):</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">Title</span> <span class="k">FROM</span> <span class="n">Books</span> <span class="k">WHERE</span> <span class="n">Author</span> <span class="o">=</span> <span class="s1">&#39;Thomas Malory&#39;</span><span class="p">;</span></code></pre></div>
<p><img src="../images/2017-08-12/table_scan.png" alt="Table Scan" /></p>
<p>The execution plan will contain a “Table Scan”, as the entire table needs to be read to complete your request.
While you will not notice an impact with just two rows, it is highly inefficient to have full scans when you query the table.
We can remedy this by creating a non-clustered index on the column we are searching <font size="3">([Author])</font> and by including columns that we want to return <font size="3">([Title])</font>.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="n">NONCLUSTERED</span> <span class="k">INDEX</span> <span class="n">IX_Books_Author</span>
    <span class="k">ON</span> <span class="n">Books</span> <span class="p">(</span><span class="n">Author</span><span class="p">)</span> <span class="n">INCLUDE</span> <span class="p">(</span><span class="n">Title</span><span class="p">);</span></code></pre></div>
<p>Running the same select query will result in an index seek, which is preferred as SQL Server traverses a b-tree to seek directly to matching records.</p>
<p><img src="../images/2017-08-12/index_seek.png" alt="Index Seek" /></p>
<p>If we want search for the opposite <font size="3">([Author] based upon [Title])</font>, an index scan would be required, as SQL Server must read the entire index to find matching values.
While not ideal, an index scan is faster than a table scan, as it should contain fewer columns.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">Author</span> <span class="k">FROM</span> <span class="n">Books</span> <span class="k">WHERE</span> <span class="n">Title</span> <span class="o">=</span> <span class="s1">&#39;Le Morte d&#39;&#39;Arthur&#39;</span><span class="p">;</span></code></pre></div>
<p><img src="../images/2017-08-12/index_scan.png" alt="Index Scan" /></p>
<p>If we want to have the [Id] column in our original result set, a table scan would again be required, as the non-clustered index does not cover that column.
Here is where we see one of the benefits of having a clustered index.
Non-clustered indexes implicitly inherit the columns of a clustered index.
By creating a clustered index on [Id], we can again achieve an index seek via our original non-clustered index.
A clustered index can be added after a table was created using an <code>ALTER TABLE</code> statement, or it can be included in the create statement by designating a column as a primary key.</p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">Books</span>   
<span class="k">ADD</span> <span class="k">CONSTRAINT</span> <span class="n">PK_Books_Id</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="n">CLUSTERED</span> <span class="p">(</span><span class="n">Id</span><span class="p">);</span>  
<span class="k">GO</span>
<span class="k">SELECT</span> <span class="n">Title</span><span class="p">,</span> <span class="n">Id</span> <span class="k">FROM</span> <span class="n">Books</span> <span class="k">WHERE</span> <span class="n">Author</span> <span class="o">=</span> <span class="s1">&#39;Thomas Malory&#39;</span><span class="p">;</span></code></pre></div>
<p><img src="../images/2017-08-12/index_seek.png" alt="Index Seek" /></p>
<p>If the non-clustered index only partially covers the data required by a query, the query optimizer may find it optimal to perform a key lookup against the clustered index to find the remaining data.
This operation is more expensive than having a covering index that can pull all required data with an index seek.</p>
<p>While this is a small sample of what can be achieved with proper indexing, knowing what to look for in your execution plans is vital in determining if your indexes are properly covering your queries or just literally wasting space.</p>
    <aside class="share">
      <div class="sharethis-inline-share-buttons"></div>
    </aside>
  </div>
  <hr>
  <aside id="comments" class="disqus">
    <div class="container">
      <h3><i class="icon icon-comments-o"></i> Comments</h3>
      <div id="disqus_thread"></div>
      <script>
          /**
           *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
           *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
           */
          //var disqus_developer = 1; // Comment out when the site is live
          var disqus_config = function () {
              this.page.url = 'http://thecynicaldba.com/indexing-for-idiots';  // Replace PAGE_URL with your page's canonical URL variable
              this.page.identifier = '/indexing-for-idiots'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
          };
          (function() {  // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');
              s.src = 'https://cynical-dba.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>
  </aside>
</article>
        </section>
<div class="clearfix"></div>
<footer class="site-footer txt-center">
  <hr>
  <ul class="social">
  </ul>
  <svg style="position: absolute; width: 0; height: 0; overflow: hidden" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
      <symbol id="icon-mug" viewBox="0 0 32 32">
      <title>coffee</title>
      <path d="M30 10h-6v-3c0-2.761-5.373-5-12-5s-12 2.239-12 5v20c0 2.761 5.373 5 12 5s12-2.239 12-5v-3h6c1.105 0 2-0.895 2-2v-10c0-1.105-0.895-2-2-2zM5.502 8.075c-1.156-0.381-1.857-0.789-2.232-1.075 0.375-0.286 1.075-0.694 2.232-1.075 1.811-0.597 4.118-0.925 6.498-0.925s4.688 0.329 6.498 0.925c1.156 0.381 1.857 0.789 2.232 1.075-0.375 0.286-1.076 0.694-2.232 1.075-1.811 0.597-4.118 0.925-6.498 0.925s-4.688-0.329-6.498-0.925zM28 20h-4v-6h4v6z"></path>
      </symbol>
    </defs>
  </svg>
  <small>&copy; 2017. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <svg class="icon-mug"><use xlink:href="#icon-mug"></use></svg>.</small>
</footer>
    </main>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jekyll-search.min.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
