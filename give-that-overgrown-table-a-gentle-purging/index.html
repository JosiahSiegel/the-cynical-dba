<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="theme-color" content="#2ecc71">
<meta property="og:url" content="http://thecynicaldba.com/give-that-overgrown-table-a-gentle-purging" />
<title> Give that overgrown table a gentle purging | the_cynical_dba</title>
<meta property="og:title" content=" Give that overgrown table a gentle purging | the_cynical_dba"/>
<meta property="og:description" name="description" content="Give that overgrown table a gentle purging" />
<meta name="keywords" content="MSSQL Server">
<link rel="stylesheet" href="/css/main.css">
<link rel="canonical" href="http://thecynicaldba.com/give-that-overgrown-table-a-gentle-purging">
<link rel="alternate" type="application/rss+xml" title="the_cynical_dba" href="http://thecynicaldba.com/feed.xml" />
<script type='text/javascript' src='//platform-api.sharethis.com/js/sharethis.js#property=5961447a33add90011bd1e36&product=inline-share-buttons' async='async'></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-102162987-1', 'auto');
  ga('send', 'pageview');
</script>
<script>base_url = "";</script>
  </head>
  <body class="single">
    <main class="main-container">
        <header class="site-header">
  <div class="container txt-center">
    <a href="#" class="nav-toogle js-menu-trigger sliding-panel-button">
      <span></span>
      <span></span>
      <span></span>
    </a>
    <nav class="js-menu sliding-panel-content">
      <ul>
        <li><a href="/">home</a></li>
        <li><a href="/author">author</a></li>
        <li><a href="/feed.xml" target="_blank"><i class="icon icon-feed"></i> feed</a></li>
      </ul>
    </nav>
    <div class="js-menu-screen sliding-panel-fade-screen"></div>
      <h1 class="page-title">Give that overgrown table a gentle purging</h1>
      <p class="post-meta">Jul 27, 2017</p>
  </div>
</header>
        <section class="main-content">
          <article class="post">
  <div class="post-content container">
    <p>You may spend much of your time making sure table data is readily available, but disk space is a finite resource that can cost you your job if not properly monitored.
Businesses usually have a required data retention period with anything beyond that being fair game, but what if all your data happens to reside in a production environment that cannot withstand heavy maintenance?</p>
<p>Assuming the table you want to clean up contains a date column, the below stored procedure will allow you to delete only a <strong>single day’s data per transaction</strong>.
Create the log table, specify the number of days you want to retain, an <em>optional</em> where clause filter, and you’re good to go.</p>
<p>Don’t trust it? Set the <code>@test_only</code> parameter to <code>'Y'</code> to force the stored procedure to ONLY print commands that it would otherwise run.
Errors will be sent to you via email if database mail is configured and an email address is specified.</p>
<p><strong>Example Usage</strong></p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">exec</span> <span class="n">incrementally_purge_rows</span>
<span class="o">@</span><span class="n">percent_trans_log_limit</span> <span class="o">=</span> <span class="mi">75</span>
<span class="p">,</span><span class="o">@</span><span class="n">days_to_retain</span> <span class="o">=</span> <span class="mi">958</span>
<span class="p">,</span><span class="o">@</span><span class="n">transaction_limit</span> <span class="o">=</span> <span class="mi">6</span>
<span class="p">,</span><span class="o">@</span><span class="n">source_database</span> <span class="o">=</span> <span class="s1">&#39;SOURCE_DB&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">source_schema</span> <span class="o">=</span> <span class="s1">&#39;dbo&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">source_table</span> <span class="o">=</span> <span class="s1">&#39;source_table&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">date_column_name</span> <span class="o">=</span> <span class="s1">&#39;entry_date&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">purge_filter</span> <span class="o">=</span> <span class="s1">&#39;Type = &#39;&#39;AA&#39;&#39;&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">log_to_table</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">test_only</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
<span class="p">,</span><span class="o">@</span><span class="n">email_error_to</span> <span class="o">=</span> <span class="s1">&#39;me@email.com&#39;</span></code></pre></div>
<p><strong>Create Script</strong></p>
<div class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="cm">/*</span>
<span class="cm">==============================================</span>
<span class="cm">Create &quot;purge_history&quot; table and run stored procedure</span>
<span class="cm">==============================================</span>
<span class="cm">*/</span>
<span class="n">USE</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span>
<span class="n">IF</span> <span class="n">OBJECT_ID</span><span class="p">(</span><span class="s1">&#39;[dbo].[purge_history]&#39;</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NULL</span>
<span class="k">BEGIN</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">purge_history</span><span class="p">](</span>
    <span class="p">[</span><span class="n">source_database</span><span class="p">]</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="p">[</span><span class="n">source_schema</span><span class="p">]</span>   <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="p">[</span><span class="n">source_table</span><span class="p">]</span>    <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="p">[</span><span class="n">days_retained</span><span class="p">]</span>   <span class="nb">INT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="p">[</span><span class="n">retention_date</span><span class="p">]</span>  <span class="n">DATETIME</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="p">[</span><span class="n">purged_rows</span><span class="p">]</span>     <span class="nb">INT</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="p">[</span><span class="n">purge_date</span><span class="p">]</span>      <span class="n">DATETIME</span> <span class="k">NULL</span><span class="p">,</span>
    <span class="p">[</span><span class="n">purge_statement</span><span class="p">]</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span> <span class="k">NULL</span>
<span class="p">)</span>
<span class="k">END</span>
<span class="k">GO</span>
<span class="n">IF</span> <span class="n">OBJECT_ID</span><span class="p">(</span><span class="s1">&#39;[dbo].[incrementally_purge_rows]&#39;</span><span class="p">)</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DROP</span> <span class="k">PROCEDURE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">incrementally_purge_rows</span><span class="p">]</span>
<span class="k">GO</span>
<span class="k">CREATE</span> <span class="k">PROCEDURE</span> <span class="p">[</span><span class="n">dbo</span><span class="p">].[</span><span class="n">incrementally_purge_rows</span><span class="p">]</span>
    <span class="o">@</span><span class="n">percent_trans_log_limit</span> <span class="nb">INT</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">,</span><span class="o">@</span><span class="n">days_to_retain</span>         <span class="nb">INT</span>
    <span class="p">,</span><span class="o">@</span><span class="n">transaction_limit</span>      <span class="nb">INT</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="p">,</span><span class="o">@</span><span class="n">source_database</span>        <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="p">,</span><span class="o">@</span><span class="n">source_schema</span>          <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="p">,</span><span class="o">@</span><span class="n">source_table</span>           <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="p">,</span><span class="o">@</span><span class="n">date_column_name</span>       <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
    <span class="p">,</span><span class="o">@</span><span class="n">purge_filter</span>           <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
    <span class="p">,</span><span class="o">@</span><span class="n">log_to_table</span>           <span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>
    <span class="p">,</span><span class="o">@</span><span class="n">test_only</span>              <span class="nb">CHAR</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
    <span class="p">,</span><span class="o">@</span><span class="n">email_error_to</span>         <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="k">AS</span>
<span class="k">SET</span> <span class="n">NOCOUNT</span> <span class="k">ON</span><span class="p">;</span>
<span class="cm">/*</span>
<span class="cm">INCREMENTALLY PURGE ROWS FROM ONE TABLE TO ANOTHER BASED UPON RETENTION PERIOD</span>
<span class="cm">Requirements:</span>
<span class="cm">====================</span>
<span class="cm">Source table must contain a date column to determine if the row is outside the retention period.</span>
<span class="cm">Required Parameters:</span>
<span class="cm">====================</span>
<span class="cm">@days_to_retain        Retention period that date column will be checked against.</span>
<span class="cm">@source_database       Name of database for table that rows will be purged from.</span>
<span class="cm">@source_schema         Name of schema for table that rows will be purged from.</span>
<span class="cm">@source_table          Name of table that rows will be purged from.</span>
<span class="cm">@date_column_name      Name of column that contains row entry date.</span>
<span class="cm">@purge_filter          Declared in &#39;WHERE&#39; clause to filter purge statement.</span>
<span class="cm">                       Set to &#39;False&#39; to disable.</span>
<span class="cm">Optional Parameters:</span>
<span class="cm">====================</span>
<span class="cm">@percent_trans_log_limit    If used transaction log space is above limit, do not begin another purge.</span>
<span class="cm">                            DEFAULT = 100. Set to 100 to disable limit.</span>
<span class="cm">@transaction_limit          Max purge iterations for procedure. Default is 1000.</span>
<span class="cm">@log_to_table               Log results to included purge_history table. Set to &#39;N&#39; to disable.</span>
<span class="cm">@test_only                  Will only print results of test run if set to &#39;Y&#39;.</span>
<span class="cm">@email_error_to             Email address to receive error alerts</span>
<span class="cm">Example:</span>
<span class="cm">====================</span>
<span class="cm">exec incrementally_purge_rows</span>
<span class="cm">@percent_trans_log_limit = 75</span>
<span class="cm">,@days_to_retain = 958</span>
<span class="cm">,@transaction_limit = 6</span>
<span class="cm">,@source_database = &#39;SOURCE_DB&#39;</span>
<span class="cm">,@source_schema = &#39;dbo&#39;</span>
<span class="cm">,@source_table = &#39;source_table&#39;</span>
<span class="cm">,@date_column_name = &#39;entry_date&#39;</span>
<span class="cm">,@purge_filter = &#39;Type = &#39;&#39;AA&#39;&#39;&#39;</span>
<span class="cm">,@log_to_table = &#39;Y&#39;</span>
<span class="cm">,@test_only = &#39;N&#39;</span>
<span class="cm">,@email_error_to = &#39;me@email.com&#39;</span>
<span class="cm">*/</span>
<span class="k">BEGIN</span>
<span class="k">DECLARE</span> 
    <span class="o">@</span><span class="n">days_retained</span>           <span class="nb">INT</span>
    <span class="p">,</span><span class="o">@</span><span class="n">percent_trans_log_used</span> <span class="nb">INT</span>
    <span class="p">,</span><span class="o">@</span><span class="n">retention_date</span>         <span class="nb">DATE</span> <span class="o">=</span> <span class="k">NULL</span>
    <span class="p">,</span><span class="o">@</span><span class="n">retention_date_stmt</span>    <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span> <span class="o">=</span> <span class="k">NULL</span>
    <span class="p">,</span><span class="o">@</span><span class="n">purge_stmt</span>             <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span> <span class="o">=</span> <span class="k">NULL</span>
    <span class="p">,</span><span class="o">@</span><span class="n">and_purge_filter</span>       <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="p">,</span><span class="o">@</span><span class="n">where_purge_filter</span>     <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="p">,</span><span class="o">@</span><span class="n">transaction_counter</span>    <span class="nb">INT</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="p">,</span><span class="o">@</span><span class="n">purge_count</span>            <span class="nb">INT</span>
    <span class="p">,</span><span class="o">@</span><span class="n">log_to_table_stmt</span>      <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
    <span class="p">,</span><span class="o">@</span><span class="n">email_last_stmt</span>        <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">4000</span><span class="p">)</span>
<span class="n">IF</span> <span class="k">LOWER</span><span class="p">(</span><span class="o">@</span><span class="n">purge_filter</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
<span class="k">BEGIN</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">purge_filter</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="k">END</span>
<span class="k">ELSE</span>
<span class="k">BEGIN</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">and_purge_filter</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39; AND &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">purge_filter</span><span class="p">;</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">where_purge_filter</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39; WHERE &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">purge_filter</span><span class="p">;</span>
<span class="k">END</span>
<span class="k">SELECT</span> <span class="o">@</span><span class="n">percent_trans_log_used</span> <span class="o">=</span> <span class="k">MAX</span><span class="p">([</span><span class="n">Percent</span> <span class="n">Log</span> <span class="n">Used</span><span class="p">])</span>
  <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span>
          <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_os_performance_counters</span>
         <span class="k">WHERE</span> <span class="n">counter_name</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;Percent Log Used&#39;</span><span class="p">)</span>
           <span class="k">AND</span> <span class="n">instance_name</span> <span class="o">=</span> <span class="o">@</span><span class="n">source_database</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Src</span>
<span class="n">PIVOT</span><span class="p">(</span><span class="k">MAX</span><span class="p">(</span><span class="n">cntr_value</span><span class="p">)</span> <span class="k">FOR</span> <span class="n">counter_name</span> <span class="k">IN</span> <span class="p">([</span><span class="n">Percent</span> <span class="n">Log</span> <span class="n">Used</span><span class="p">]))</span> <span class="k">AS</span> <span class="n">pvt</span>
<span class="k">WHERE</span> <span class="p">[</span><span class="n">Percent</span> <span class="n">Log</span> <span class="n">Used</span><span class="p">]</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">retention_date_stmt</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;SELECT @retention_date = min(&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">date_column_name</span> <span class="o">+</span> <span class="s1">&#39;) from &#39;</span> 
  <span class="o">+</span> <span class="o">@</span><span class="n">source_database</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_table</span> <span class="o">+</span> <span class="o">@</span><span class="n">where_purge_filter</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">email_last_stmt</span> <span class="o">=</span> <span class="o">@</span><span class="n">retention_date_stmt</span>
<span class="k">EXEC</span> <span class="n">sp_executesql</span> <span class="o">@</span><span class="n">retention_date_stmt</span>
    <span class="p">,</span><span class="n">N</span><span class="s1">&#39;@retention_date DATE OUTPUT&#39;</span>
    <span class="p">,</span><span class="o">@</span><span class="n">retention_date</span> <span class="o">=</span> <span class="o">@</span><span class="n">retention_date</span> <span class="k">OUTPUT</span><span class="p">;</span>
<span class="k">SET</span> <span class="o">@</span><span class="n">days_retained</span> <span class="o">=</span> <span class="n">DATEDIFF</span><span class="p">(</span><span class="k">DAY</span><span class="p">,</span> <span class="o">@</span><span class="n">retention_date</span><span class="p">,</span> <span class="n">getdate</span><span class="p">())</span>
<span class="n">PRINT</span> <span class="s1">&#39;Old retention date: &#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">retention_date</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
<span class="n">PRINT</span> <span class="s1">&#39;Days retained: &#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">days_retained</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">days_to_retain</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="o">+</span> <span class="s1">&#39;, Percent log used: &#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">percent_trans_log_used</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="n">WHILE</span>
<span class="p">((</span><span class="o">@</span><span class="n">percent_trans_log_used</span> <span class="o">&lt;=</span> <span class="o">@</span><span class="n">percent_trans_log_limit</span><span class="p">)</span> <span class="k">OR</span> <span class="o">@</span><span class="n">percent_trans_log_limit</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="k">AND</span>
<span class="p">(</span><span class="o">@</span><span class="n">days_retained</span> <span class="o">&gt;</span> <span class="o">@</span><span class="n">days_to_retain</span><span class="p">)</span>
<span class="k">AND</span>
<span class="p">(</span><span class="o">@</span><span class="n">transaction_counter</span> <span class="o">&lt;</span> <span class="o">@</span><span class="n">transaction_limit</span><span class="p">)</span>
<span class="k">BEGIN</span>
  <span class="n">PRINT</span> <span class="s1">&#39;&#39;</span>
  <span class="k">BEGIN</span> <span class="n">TRANSACTION</span>
  <span class="k">BEGIN</span> <span class="n">TRY</span>
    <span class="k">SET</span> <span class="o">@</span><span class="n">purge_stmt</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;</span>
<span class="s1">    DELETE &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_database</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_table</span> <span class="o">+</span> <span class="s1">&#39;</span>
<span class="s1">    WHERE CONVERT(DATE, &#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">date_column_name</span> <span class="o">+</span> <span class="s1">&#39;) &lt;= &#39;&#39;&#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">retention_date</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;&#39;&#39;&#39;</span> 
	<span class="o">+</span> <span class="o">@</span><span class="n">and_purge_filter</span>
    <span class="k">SET</span> <span class="o">@</span><span class="n">email_last_stmt</span> <span class="o">=</span> <span class="o">@</span><span class="n">purge_stmt</span>
    <span class="n">IF</span> <span class="o">@</span><span class="n">test_only</span> <span class="o">=</span> <span class="s1">&#39;N&#39;</span>
    <span class="k">BEGIN</span>
      <span class="k">EXEC</span> <span class="n">sp_executesql</span> <span class="o">@</span><span class="n">purge_stmt</span><span class="p">;</span>
    <span class="k">END</span>
    <span class="k">ELSE</span>
    <span class="k">BEGIN</span>
      <span class="n">PRINT</span> <span class="s1">&#39;*test only*&#39;</span>
      <span class="n">PRINT</span> <span class="s1">&#39;Statement to purge rows:&#39;</span>
      <span class="n">PRINT</span> <span class="o">@</span><span class="n">purge_stmt</span>
    <span class="k">END</span>
    <span class="k">SET</span> <span class="o">@</span><span class="n">purge_count</span> <span class="o">=</span> <span class="o">@@</span><span class="n">ROWCOUNT</span>
  <span class="cm">/*</span>
<span class="cm">  ==============================================</span>
<span class="cm">  Purge from source complete.</span>
<span class="cm">  ==============================================</span>
<span class="cm">  */</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">retention_date_stmt</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;SELECT @retention_date = min(&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">date_column_name</span> <span class="o">+</span> <span class="s1">&#39;) from &#39;</span> 
  <span class="o">+</span> <span class="o">@</span><span class="n">source_database</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_schema</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_table</span> <span class="o">+</span> <span class="o">@</span><span class="n">where_purge_filter</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">email_last_stmt</span> <span class="o">=</span> <span class="o">@</span><span class="n">retention_date_stmt</span>
  <span class="k">EXEC</span> <span class="n">sp_executesql</span> <span class="o">@</span><span class="n">retention_date_stmt</span>
      <span class="p">,</span><span class="n">N</span><span class="s1">&#39;@retention_date DATE OUTPUT&#39;</span>
      <span class="p">,</span><span class="o">@</span><span class="n">retention_date</span> <span class="o">=</span> <span class="o">@</span><span class="n">retention_date</span> <span class="k">OUTPUT</span><span class="p">;</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">days_retained</span> <span class="o">=</span> <span class="n">DATEDIFF</span><span class="p">(</span><span class="k">DAY</span><span class="p">,</span> <span class="o">@</span><span class="n">retention_date</span><span class="p">,</span> <span class="n">getdate</span><span class="p">())</span>
  <span class="c1">--Replace single quotes before log insert</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">purge_stmt</span> <span class="o">=</span>  <span class="k">REPLACE</span><span class="p">(</span><span class="o">@</span><span class="n">purge_stmt</span><span class="p">,</span> <span class="s1">&#39;&#39;&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;&#39;&#39;&#39;&#39;</span><span class="p">)</span> 
  <span class="k">SET</span> <span class="o">@</span><span class="n">log_to_table_stmt</span> <span class="o">=</span> <span class="n">N</span><span class="s1">&#39;</span>
<span class="s1">  INSERT INTO master.dbo.purge_history (</span>
<span class="s1">    [source_database],</span>
<span class="s1">    [source_schema],</span>
<span class="s1">    [source_table],</span>
<span class="s1">    [days_retained],</span>
<span class="s1">    [retention_date],</span>
<span class="s1">    [purged_rows],</span>
<span class="s1">    [purge_date],</span>
<span class="s1">    [purge_statement])</span>
<span class="s1">  VALUES (</span>
<span class="s1">    &#39;</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_database</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,</span>
<span class="s1">    &#39;</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_schema</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,</span>
<span class="s1">    &#39;</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="o">@</span><span class="n">source_table</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;,</span>
<span class="s1">    CAST(&#39;</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">days_retained</span> <span class="k">AS</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">23</span><span class="p">))</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; AS INT),</span>
<span class="s1">    CAST(&#39;</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">retention_date</span> <span class="k">AS</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">23</span><span class="p">))</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; AS DATE),</span>
<span class="s1">    CAST(&#39;</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">purge_count</span> <span class="k">AS</span> <span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">23</span><span class="p">))</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; AS INT),</span>
<span class="s1">    CAST(&#39;</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="k">CONVERT</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">(</span><span class="mi">23</span><span class="p">),</span> <span class="n">getdate</span><span class="p">(),</span> <span class="mi">121</span><span class="p">)</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; AS DATETIME),</span>
<span class="s1">    &#39;</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="o">@</span><span class="n">purge_stmt</span> <span class="o">+</span> <span class="nb">CHAR</span><span class="p">(</span><span class="mi">39</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)</span>
<span class="s1">  &#39;</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">email_last_stmt</span> <span class="o">=</span> <span class="o">@</span><span class="n">log_to_table_stmt</span>
  <span class="n">IF</span> <span class="o">@</span><span class="n">log_to_table</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>
  <span class="k">BEGIN</span>
    <span class="k">EXECUTE</span> <span class="n">dbo</span><span class="p">.</span><span class="n">sp_executesql</span> <span class="o">@</span><span class="n">log_to_table_stmt</span>
  <span class="k">END</span>
  <span class="k">ELSE</span>
  <span class="k">BEGIN</span>
    <span class="n">PRINT</span> <span class="s1">&#39;Statement to log to purge_history:&#39;</span>
    <span class="n">PRINT</span> <span class="o">@</span><span class="n">log_to_table_stmt</span>
  <span class="k">END</span>
  <span class="cm">/*</span>
<span class="cm">  ==============================================</span>
<span class="cm">  Log activity to purge_history table complete.</span>
<span class="cm">  ==============================================</span>
<span class="cm">  */</span>
  <span class="k">COMMIT</span>
  <span class="n">PRINT</span> <span class="s1">&#39;Commit successful&#39;</span>
  <span class="k">END</span> <span class="n">TRY</span>
  <span class="k">BEGIN</span> <span class="n">CATCH</span>
    <span class="n">PRINT</span> <span class="s1">&#39;Begin rollback&#39;</span>
    <span class="k">ROLLBACK</span>
    <span class="n">PRINT</span> <span class="s1">&#39;Rollback successful&#39;</span>
    <span class="k">SET</span> <span class="o">@</span><span class="n">purge_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">EXEC</span> <span class="n">msdb</span><span class="p">.</span><span class="n">dbo</span><span class="p">.</span><span class="n">sp_send_dbmail</span>
         <span class="o">@</span><span class="n">recipients</span> <span class="o">=</span> <span class="o">@</span><span class="n">email_error_to</span><span class="p">,</span>
         <span class="o">@</span><span class="n">subject</span> <span class="o">=</span> <span class="s1">&#39;Purge Failure&#39;</span><span class="p">,</span>
         <span class="o">@</span><span class="n">body</span> <span class="o">=</span> <span class="o">@</span><span class="n">email_last_stmt</span>
  <span class="k">END</span> <span class="n">CATCH</span>
  <span class="n">PRINT</span> <span class="s1">&#39;New retention date: &#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">retention_date</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
  <span class="k">SELECT</span> <span class="o">@</span><span class="n">percent_trans_log_used</span> <span class="o">=</span> <span class="k">MAX</span><span class="p">([</span><span class="n">Percent</span> <span class="n">Log</span> <span class="n">Used</span><span class="p">])</span>
  <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span>
          <span class="k">FROM</span> <span class="n">sys</span><span class="p">.</span><span class="n">dm_os_performance_counters</span>
         <span class="k">WHERE</span> <span class="n">counter_name</span> <span class="k">IN</span> <span class="p">(</span><span class="s1">&#39;Percent Log Used&#39;</span><span class="p">)</span>
           <span class="k">AND</span> <span class="n">instance_name</span> <span class="o">=</span> <span class="o">@</span><span class="n">source_database</span><span class="p">)</span> <span class="k">AS</span> <span class="n">Src</span>
  <span class="n">PIVOT</span><span class="p">(</span><span class="k">MAX</span><span class="p">(</span><span class="n">cntr_value</span><span class="p">)</span> <span class="k">FOR</span> <span class="n">counter_name</span> <span class="k">IN</span> <span class="p">([</span><span class="n">Percent</span> <span class="n">Log</span> <span class="n">Used</span><span class="p">]))</span> <span class="k">AS</span> <span class="n">pvt</span>
  <span class="k">WHERE</span> <span class="p">[</span><span class="n">Percent</span> <span class="n">Log</span> <span class="n">Used</span><span class="p">]</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span>
  <span class="k">SET</span> <span class="o">@</span><span class="n">transaction_counter</span> <span class="o">=</span> <span class="o">@</span><span class="n">transaction_counter</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">PRINT</span> <span class="s1">&#39;Days retained: &#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">days_retained</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">days_to_retain</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> 
  <span class="o">+</span> <span class="s1">&#39;, Percent log used: &#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">percent_trans_log_used</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
  <span class="n">PRINT</span> <span class="s1">&#39;Transaction counter: &#39;</span> <span class="o">+</span> <span class="k">CAST</span><span class="p">(</span><span class="o">@</span><span class="n">transaction_counter</span> <span class="k">AS</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="k">END</span>
<span class="k">END</span>
<span class="k">GO</span></code></pre></div>
    <aside class="share">
      <div class="sharethis-inline-share-buttons"></div>
    </aside>
  </div>
  <hr>
  <aside id="comments" class="disqus">
    <div class="container">
      <h3><i class="icon icon-comments-o"></i> Comments</h3>
      <div id="disqus_thread"></div>
      <script>
          /**
           *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
           *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
           */
          //var disqus_developer = 1; // Comment out when the site is live
          var disqus_config = function () {
              this.page.url = 'http://thecynicaldba.com/give-that-overgrown-table-a-gentle-purging';  // Replace PAGE_URL with your page's canonical URL variable
              this.page.identifier = '/give-that-overgrown-table-a-gentle-purging'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
          };
          (function() {  // DON'T EDIT BELOW THIS LINE
              var d = document, s = d.createElement('script');
              s.src = 'https://cynical-dba.disqus.com/embed.js';
              s.setAttribute('data-timestamp', +new Date());
              (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>
  </aside>
</article>
        </section>
<div class="clearfix"></div>
<footer class="site-footer txt-center">
  <hr>
  <ul class="social">
  </ul>
  <svg style="position: absolute; width: 0; height: 0; overflow: hidden" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <defs>
      <symbol id="icon-mug" viewBox="0 0 32 32">
      <title>coffee</title>
      <path d="M30 10h-6v-3c0-2.761-5.373-5-12-5s-12 2.239-12 5v20c0 2.761 5.373 5 12 5s12-2.239 12-5v-3h6c1.105 0 2-0.895 2-2v-10c0-1.105-0.895-2-2-2zM5.502 8.075c-1.156-0.381-1.857-0.789-2.232-1.075 0.375-0.286 1.075-0.694 2.232-1.075 1.811-0.597 4.118-0.925 6.498-0.925s4.688 0.329 6.498 0.925c1.156 0.381 1.857 0.789 2.232 1.075-0.375 0.286-1.076 0.694-2.232 1.075-1.811 0.597-4.118 0.925-6.498 0.925s-4.688-0.329-6.498-0.925zM28 20h-4v-6h4v6z"></path>
      </symbol>
    </defs>
  </svg>
  <small>&copy; 2017. Made with <a href="http://jekyllrb.com" target="_blank">Jekyll</a> and <svg class="icon-mug"><use xlink:href="#icon-mug"></use></svg>.</small>
</footer>
    </main>
    <script src="/js/jquery.min.js"></script>
    <script src="/js/jekyll-search.min.js"></script>
    <script src="/js/main.js"></script>
  </body>
</html>
